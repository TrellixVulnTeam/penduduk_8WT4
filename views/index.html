{% extends 'base.html' %}
{% block title %}
    Halaman Utama
{% endblock %}
{% block inlinejstop %}
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/holder/2.9.0/holder.js"></script>
  <script src="../demo/demo.js"></script>
{% endblock %}
{% block inlinecss %}
  <link href="css/widgets.min.css" rel="stylesheet" type="text/css">
{% endblock %}
<!-- Content -->
{% block content %}
<div class="page-header">
  <h1>Statistik Penduduk <small id="area"></small></h1>
</div>

<div class="page-wide-block">
  <div class="box m-a-0 border-radius-0" id="metrics">
    <div class="box-row valign-top">
      <div class="box-cell col-md-12 p-x-4 p-t-3 p-b-4">
        <div class="m-b-1 text-muted font-weight-semibold font-size-11">Agama</div>
        <div id="religionChart" style="min-height: 120px"></div>
      </div>
      <div class="box-cell col-md-12 p-x-4 p-t-3 p-b-4">
        <div class="m-b-1 text-muted font-weight-semibold font-size-11">Golongan Darah</div>
        <div id="bloodtypeChart" style="min-height: 120px"></div>
      </div>
      <div class="box-cell col-md-12 p-x-4 p-t-3 p-b-4">
        <div class="m-b-1 text-muted font-weight-semibold font-size-11">Pernikahan</div>
        <div id="marriageChart" style="min-height: 120px"></div>
      </div>
    </div>
    <div class="box-row valign-top">
      <div class="box-cell col-md-12 p-x-4 p-t-3 p-b-4">
        <div class="m-b-1 text-muted font-weight-semibold font-size-11">Jenis Kelamin</div>
        <div id="genderChart" style="min-height: 120px"></div>
      </div>
      <div class="box-cell col-md-12 p-x-4 p-t-3 p-b-4">
        <div class="m-b-1 text-muted font-weight-semibold font-size-11">Pekerjaan</div>
        <div id="jobChart" style="min-height: 120px"></div>
      </div>
      <div class="box-cell col-md-12 p-x-4 p-t-3 p-b-4">
        <div class="m-b-1 text-muted font-weight-semibold font-size-11">Jenjang Studi</div>
        <div id="studyChart" style="min-height: 120px"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block inlinejs %}
<script type="text/javascript">
$(function(){
  setTimeout(()=>{
    console.log('current User: '+currentUser.email);
    var province = currentUser.area.province;
    var city = currentUser.area.city;
    var district = currentUser.area.district;
    var subdistrict = currentUser.area.subdistrict;
    switch(currentUser.level){
        case 'province':
            $('#filterProvince').hide();
            break;
        case 'city':
            $('#filter').hide();
            break;
        case 'district':
            $(location).attr('href','/kecamatan/'+province+'/'+city+'/'+district);
            break;
        case 'subdistrict':
            $(location).attr('href','/kelurahan/'+province+'/'+city+'/'+district+'/'+subdistrict);
            break;
    }
    
  },7000);

  var chartColors = pxDemo.getRandomColors(12);

  var penduduk = db.collection('penduduk');

  var religionArray = [];
  var bloodtypeArray = [];
  var marriageArray = [];
  var genderArray = [];
  var jobArray = [];
  var studyArray = [];

  generateData('religion',religionArray,'#religionChart',chartColors);
  generateData('bloodtype',bloodtypeArray,'#bloodtypeChart',chartColors);
  generateData('gender',genderArray, '#genderChart',chartColors);
  generateData('marriage',marriageArray,'#marriageChart',chartColors);
  generateData('gender',genderArray, '#genderChart',chartColors);
  generateData('job',jobArray, '#jobChart',chartColors);
  generateData('study',studyArray, '#studyChart',chartColors);

});

function getPropertyData(property,data){
  switch(property){
          case 'religion':
            return data.agama;
          case 'bloodtype':
            return data.golongan_darah;
          case 'marriage':
            return data.status_perkawinan;
          case 'gender':
            return data.jenis_kelamin;
          case 'job':
            return data.bidang_pekerjaan;
          case 'study':
            return data.pendidikan;
  }
}

function generateData(property,dataArray,objectId,chartColors){
  penduduk.get().then((querySnapshot)=>{
    querySnapshot.forEach((doc)=>{
      if(doc && doc.exists){
        var id = doc.id;
        var data = getPropertyData(property,doc.data());
        console.log(property+': '+data);
        var exist = dataExists(data,dataArray);
        if(!exist){
          addData(data, dataArray);
        }
        var members = penduduk.doc(id).collection('anggota');
        // if(members){
          members.get().then((query)=>{
            query.forEach((member)=>{
              var memberData = getPropertyData(property,member.data());
              console.log(property+': '+memberData);
              var memberExist = dataExists(memberData,dataArray);
              if(!memberExist){
                addData(memberData, dataArray);
              }
            });
          });        
        // }
      }
    });

    var chartData = {
      columns : dataArray,
      type : 'pie'
    };
    setTimeout(function(){
      c3.generate({
        size:{
          height: 400
        },
        bindto : objectId,
        color: { pattern: chartColors },
        data: chartData,
        legend: { position: 'bottom' }
      });
    },2000);

  });
}

function whereClause(doc,array){
    if(array.length){
        array.forEach((data)=>{
            doc = doc.where(data.title,'==',data.value);
        });
    }
    return doc;
}

function filterType(data, typeData){
    switch(typeData){
        case 'province':
            return data.provinsi;
        case 'city':
            return data.kota;
        case 'district':
            return data.kecamatan;
        case 'subdistrict':
            return data.kelurahan;
        case 'rw':
            return data.rw;
        case 'rt':
            return data.rt;
    }
}

function dataExists(str, dataArray){
  var exist = false;
  dataArray.forEach((data)=>{
      if(str.toLowerCase()==data[0].toLowerCase()){
          data[1]=data[1]+1;
          exist = true;
          return exist;
      }
  });
  return exist;
}

function addData( str, dataArray){
  dataArray.push([str,1]);
} 

</script>
{% endblock %}