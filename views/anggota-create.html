{% extends 'base.html' %}
{% block title %}
     Detail Penduduk
{% endblock %}

{% block inlinecss %}
<style>
    .page-profile-v1-avatar {
        max-width: 160px;
        border: 4px solid #fff;
    }
</style>
{% endblock %}
<!-- Content -->
{% block content %}
<div class="row m-t-1">

    <div class="col-md-12 col-lg-12">
        <h1 class="font-size-20 m-y-4">
            <span id="profileName">
                Tambah Anggota Keluarga
            </span>

        </h1>

        <ul class="nav nav-tabs" id="profile-tabs">
            <li class="active">
                <a href="#profileInfo" data-toggle="tab" id="profileInfoBtn">
                    Data Pribadi
                </a>
            </li>
        </ul>

        <div class="tab-content tab-content-bordered p-a-0 bg-white">
            <div class="tab-pane fade in active" id="profileInfo">
              <div class="row text-xs-center" style="padding:30px">
                <div class="col-md-6">
                  <h4 class="text-center" style="margin-top:0;margin-bottom:12px">Unggah Foto Profil</h4>
                  <img src="/demo/avatars/account.png" alt="" style="width:20%;border-radius:5px" id="profilePicture">
                  <br>
                  <br>
                  <input type="file" id="profileUpload" class="form-control">
                </div>
                <div class="col-md-6">
                  <h4 class="text-center" style="margin-top:0;margin-bottom:12px">Unggah Foto KTP</h4>
                  <img src="/images/card_container.png" alt="" style="width:30%;border-radius:5px" id="idPicture">
                  <br>
                  <br>
                  <input type="file" id="idUpload" class="form-control">
                  <br>
                  <!-- <button id="profileImgUploadBtn" class="btn btn-warning" style="width:100%">Unggah Gambar</button> -->
                </div>
              </div>
            </div>
        </div>
    </div>
</div>
<div class="modal" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top: 15%; overflow-y: visible;" id="modalLoading">
  <div class="modal-dialog modal-m">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0;">Sedang mengunggah gambar..</h3>
      </div>
      <div class="modal-body">
        <div class="progress progress-striped active" style="margin-bottom:0;">
          <div class="progress-bar" style="width: 100%">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block inlinejs  %}
    <script type="text/javascript">
        var profileInfo = $('#profileInfo');
        var familyInfo = $('#familyInfo');
        var assetInfo = $('#assetInfo');
        // var id = '{{id}}';
        var kkId = '{{kkId}}';

        var penduduk = db.collection('penduduk');
        // var person = penduduk.doc(kkId).collection('anggota').doc(id);
        var storageRef = storage.ref();

        var dataContainer = $('#dataContainer');
        var counter = 1;
        var dataArray = [];
        var selectArray = [];
        var result = null;

        console.log(dataArray);
        var optionObject = {
          affirmative: ['Iya','Tidak'],
          marriage : ['Belum Kawin','Kawin','Cerai Hidup','Cerai Mati'],
          education : ['Tidak / Belum Sekolah','Belum tamat SD','SD','SLTP / Sederajad','SLTA / Sederajad','Diploma I / II','Diploma III / Sarjana Muda','Strata I','Strata II','Strata III'],
          status : ['Suami','Istri','Anak Laki-Laki','Anak Perempuan'],
          religion : ['Islam','Kristen Protestan','Katolik','Hindu','Buddha','Kong Hu Cu'],
          bloodType : ['A','B','AB','O'],
          gender:['Pria','Wanita'],
          jobField : ['Pelayanan Jasa Kesehatan','Pelayanan Jasa Transportasi','Jasa Perbaikan Alat Transportasi','Usaha Pariwisata','Jasa Pos dan Telekomunikasi','Jasa Penyediaan Tenaga Listrik','Jasa Jaringan Pelayanan Air Bersih (PAM)','Jasa Penyediaan Bahan Bakar Minyak dan Gas Bumi','Usaha Swalayan, Pusat Perbelanjaan, dan sejenisnya','Usaha Pusat Perbelanjaan, dan sejenisnya','Media Masa','Pengamanan','Lembaga Konservasi'],
          income:['Tidak Berpenghasilan','Dibawah Rp. 500.000','Rp 500.001 hingga Rp 2.000.000','Rp 2.000.001 hingga Rp 5.000.000','Rp 5.000.001 hingga Rp 10.000.000','Rp 10.000.001 hingga Rp 25.000.000','Diatas Rp 25.000.000'],
          nationality:['Indonesia','Warga Negara Asing']
        };

        $('#profileInfoBtn').on('click',function(){
              var name,gender ,status ,income ,jobField ,bloodType ,job,education ,nationality,marriage ,birthPlace ,birthDate ,religion ='';

              var arrayData = [
                  {title:'Nama Lengkap', name:'name'},
                  {title:'Jenis Kelamin', options:optionObject.gender,name:'gender'},
                  {title:'Status dalam Keluarga',options:optionObject.status,name:'status'},
                  {title:'Kisaran Penghasilan', options:optionObject.income,name:'income'},
                  {title:'Bidang Pekerjaan', options:optionObject.jobField,name:'job_field'},
                  {title:'Pekerjaan', name:'job'},

                  {title:'Pendidikan', options:optionObject.education,name:'education'},
                  {title:'Kewarganegaraan', options:optionObject.nationality,name:'nationality'},

                  {title:'Agama', options:optionObject.religion,name:'religion'},
                  {title:'Golongan Darah', options:optionObject.bloodType,name:'blood_type'},


                  {title:'Status Perkawinan', options:optionObject.marriage,name:'marriage'},
                  {title:'Tempat Lahir', name:'birth_place'},
                  {title:'Tanggal Lahir', name:'birth_date'}
              ];

              console.log(arrayData);

              var toAppend = '';
              arrayData.forEach((data)=>{
                var input = '';
                if(!data.options){
                  input = '<input name="'+data.name+'" class="text-default form-control" required>';
                }
                else{
                  var options = '';
                  data.options.forEach((option)=>{
                      options+='<option>'+option+'</option>';
                  });
                  input = '<select name="'+data.name+'" class="select2 form-control" required>'+options+'</select>';
                }

                toAppend+='<tr>'+
                            '<td style="padding:20px">'+
                              '<div class="box m-a-0 bg-transparent">'+
                                '<span class="page-messages-item-from box-cell text-default">'+
                                    data.title+
                                '</span>'+
                                '<div class="page-messages-item-subject box-cell">'+
                                    input+
                                '</div>'+
                              '</div>'+
                            '</td>'+
                          '</tr>';
              });
              profileInfo.append(
                  '<form>'+
                  '<input type="hidden" value="'+kkId+'" name="kk_id">'+
                  '<table class="page-messages-items table m-a-0">'+
                          '<tbody>'+
                              toAppend+
                          '</tbody>'+
                  '</table>'+
                  '<input style="margin:20px" class="btn btn-success pull-right" type="submit" value="Simpan" id="saveMember">'+
                  '</form>'
              );

        });

        $('#profileImgUploadBtn').on('click',function(){
          $('#modalLoading').modal('show');
          var photoProfile = $('#profileUpload').prop('files')[0];
          var photoId = $('#idUpload').prop('files')[0];
          var resident = penduduk.doc(kkId).collection('anggota').doc(id);
          if(photoProfile){
            var pName = 'images/p-'+id+'.jpg';
            var pStorageRef=firebase.storage().ref(pName);
            var pTask = pStorageRef.put(photoProfile);
            pTask.on('state_changed',
              function complete(){
                resident.update({
                  foto_orang:pName
                });
              },
              function error(err){
                console.log('error: '+err);
              }
            );
          }

          if(photoId){
            var iName = 'images/i-'+id+'.jpg';
            var iStorageRef=firebase.storage().ref(iName);
            var iTask = iStorageRef.put(photoId);
            iTask.on('state_changed',
              function complete(){
                resident.update({
                  foto_ktp:iName
                });
              },
              function error(err){
                console.log('error: '+err);
              }
            );
          }

          setTimeout(function(){
            $(location).attr('href','/anggota-edit/'+kkId+'/'+id);
          },5000);


        });

        $(document).on('click','#saveMember',function(){
          console.log('hahahahah');
          // location.reload(true);
        });

        function init(){
            $('#profileInfoBtn').click();
        }


    </script>
{% endblock %}
